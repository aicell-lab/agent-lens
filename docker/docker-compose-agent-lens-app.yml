services:
  agent-lens:
    image: ghcr.io/aicell-lab/agent-lens:sha-152cb35
    container_name: agent-lens
    # Optimize image pulling
    pull_policy: if_not_present
    environment:
      - WORKSPACE_TOKEN=${WORKSPACE_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - REEF_WORKSPACE_TOKEN=${REEF_WORKSPACE_TOKEN}
      - HYPHA_AGENTS_TOKEN=${HYPHA_AGENTS_TOKEN}
      - NVIDIA_VISIBLE_DEVICES=all  # Make GPU visible to container
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility  # Enable GPU compute capabilities
    labels:
      - "autoheal.enable=true"
    volumes:
      - agent-lens-cache:/app/.cache
    # GPU support: Use runtime for docker-compose, or deploy.resources for docker swarm
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
      restart_policy:
        condition: on-failure
        delay: 20s
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "curl -s https://hypha.aicell.io/agent-lens/services/probes/liveness | jq -e '.status == \"ok\"'"]
      interval: 120s
      timeout: 50s
      retries: 3
      start_period: 300s
    restart: on-failure
    stop_grace_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  squid-control:
    image: ghcr.io/aicell-lab/squid-control:sha-4943ddb
    container_name: squid-control
    # Optimize image pulling
    pull_policy: if_not_present
    network_mode: "host"
    ports:
      - "10000-10050:10000-10050/udp"
    environment:
      - SQUID_WORKSPACE_TOKEN=${SQUID_WORKSPACE_TOKEN}
      - WORKSPACE_TOKEN_CHATBOT=${WORKSPACE_TOKEN_CHATBOT}
      - REEF_WORKSPACE_TOKEN=${REEF_WORKSPACE_TOKEN}
      - MICROSCOPE_SERVICE_ID=${MICROSCOPE_SERVICE_ID} # will be squid-control-simulation or squid-control-simulation-63x
      - WORKSPACE_TOKEN=${WORKSPACE_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AGENT_LENS_WORKSPACE_TOKEN=${AGENT_LENS_WORKSPACE_TOKEN}
    labels:
      - "autoheal.enable=true"
    volumes:
      - squid-control-cache:/app/.cache
      - /mnt/shared_documents/20251215-illumination-calibrated/data.zarr:/mnt/shared_documents/20251215-illumination-calibrated/data.zarr:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "curl -s https://hypha.aicell.io/agent-lens/services/squid-control-simulation/is_service_healthy | jq -e '.status == \"ok\"'"]
      interval: 120s
      timeout: 30s
      retries: 1
      start_period: 120s
    restart: on-failure
    stop_grace_period: 30s
    deploy:
      restart_policy:
        condition: on-failure
        delay: 20s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  squid-control-63x:
    image: ghcr.io/aicell-lab/squid-control:sha-4943ddb
    container_name: squid-control-63x
    # Optimize image pulling
    pull_policy: if_not_present
    network_mode: "host"
    ports:
      - "10100-10150:10100-10150/udp"
    environment:
      - SQUID_WORKSPACE_TOKEN=${SQUID_WORKSPACE_TOKEN}
      - WORKSPACE_TOKEN_CHATBOT=${WORKSPACE_TOKEN_CHATBOT}
      - REEF_WORKSPACE_TOKEN=${REEF_WORKSPACE_TOKEN}
      - MICROSCOPE_SERVICE_ID=${MICROSCOPE_SERVICE_ID} # will be squid-control-simulation or squid-control-simulation-63x
      - WORKSPACE_TOKEN=${WORKSPACE_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AGENT_LENS_WORKSPACE_TOKEN=${AGENT_LENS_WORKSPACE_TOKEN}
    labels:
      - "autoheal.enable=true"
    volumes:
      - squid-control-63x-cache:/app/.cache
      # Mount 63x zarr dataset (Opera import)
      - /mnt/shared_documents/opera_import/data.zarr:/mnt/shared_documents/opera_import/data.zarr:ro
    command: ["python", "-m", "squid_control", "microscope", "--simulation", "--config", "HCS_v2_63x"]
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "curl -s https://hypha.aicell.io/agent-lens/services/squid-control-simulation-63x/is_service_healthy | jq -e '.status == \"ok\"'"]
      interval: 120s
      timeout: 30s
      retries: 1
      start_period: 120s
    restart: on-failure
    stop_grace_period: 30s
    deploy:
      restart_policy:
        condition: on-failure
        delay: 20s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    # Optimize image pulling
    pull_policy: if_not_present
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal.enable
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=300
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  agent-lens-cache:
  squid-control-cache:
  squid-control-63x-cache: