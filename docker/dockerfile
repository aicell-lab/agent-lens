# syntax=docker/dockerfile:1.3.1
FROM python:3.11-slim

# Install git and other system dependencies
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update

# Set environment to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install packages with proper dependency handling
RUN apt-get update && \
    # Install packages including git (perl is already available from base image)
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        jq \
        git && \
    # Install Node.js
    curl -sL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    # Clean up
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a non-root user with explicit UID/GID
RUN groupadd -r -g 1000 agent_lens && useradd -r -u 1000 -g agent_lens -m agent_lens

# Set the working directory
WORKDIR /app/

# Create necessary directories with correct permissions
RUN mkdir -p /app/logs /app/.cache && \
    chown -R agent_lens:agent_lens /app /app/logs /app/.cache && \
    chmod -R 755 /app

# Create a directory for global npm packages in the user's home
RUN mkdir -p /home/agent_lens/.npm-global && \
    chown -R agent_lens:agent_lens /home/agent_lens/.npm-global

# Switch to the non-root user
USER agent_lens

# Set environment variables
ENV HOME=/home/agent_lens \
    CLIP_CACHE=/app/.cache \
    npm_config_cache=/home/agent_lens/.npm \
    NPM_CONFIG_PREFIX=/home/agent_lens/.npm-global \
    PATH="/home/agent_lens/.local/bin:${PATH}" \
    PATH="/home/agent_lens/.local/bin:/home/agent_lens/.npm-global/bin:${PATH}"

# Copy files with correct ownership
COPY --chown=agent_lens:agent_lens pyproject.toml README.md ./
COPY --chown=agent_lens:agent_lens agent_lens ./agent_lens
COPY --chown=agent_lens:agent_lens frontend ./frontend
COPY --chown=agent_lens:agent_lens scripts ./scripts

# Copy package files first
COPY --chown=agent_lens:agent_lens frontend/package*.json frontend/vite.config.mjs ./frontend/

# Configure npm to use the new global directory
RUN npm config set prefix '/home/agent_lens/.npm-global'

# Install frontend dependencies and build
RUN npm install --prefix frontend && \
    npm install --prefix frontend react-color html2canvas && \
    cd frontend && \
    npm run build && \
    cd ..

RUN pip install --upgrade pip
RUN pip install --user -e .

# Ensure the start script is executable
RUN chmod +x /app/scripts/docker_start.sh

ENTRYPOINT ["/app/scripts/docker_start.sh"]