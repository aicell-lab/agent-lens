# syntax=docker/dockerfile:1.3.1
# Use CUDA-enabled base image for GPU support
FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Set environment to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install git and other system dependencies
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update && \
    # Install Python 3.11 and other system packages
    apt-get install -y --no-install-recommends \
        python3.11 \
        python3.11-dev \
        python3-pip \
        python3.11-distutils \
        ca-certificates \
        curl \
        jq \
        git \
        && \
    # Install Node.js
    curl -sL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    # Create symlinks for python/pip (force overwrite if exists)
    ln -sf /usr/bin/python3.11 /usr/bin/python && \
    ln -sf /usr/bin/python3.11 /usr/bin/python3 && \
    # Clean up
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a non-root user with explicit UID/GID
RUN groupadd -r -g 1000 agent_lens && useradd -r -u 1000 -g agent_lens -m agent_lens

# Set the working directory
WORKDIR /app/

# Create necessary directories with correct permissions
RUN mkdir -p /app/logs /app/.cache && \
    chown -R agent_lens:agent_lens /app /app/logs /app/.cache && \
    chmod -R 755 /app

# Create a directory for global npm packages in the user's home
RUN mkdir -p /home/agent_lens/.npm-global && \
    chown -R agent_lens:agent_lens /home/agent_lens/.npm-global

# Switch to the non-root user
USER agent_lens

# Set environment variables
ENV HOME=/home/agent_lens \
    CLIP_CACHE=/app/.cache \
    npm_config_cache=/home/agent_lens/.npm \
    NPM_CONFIG_PREFIX=/home/agent_lens/.npm-global \
    PATH="/home/agent_lens/.local/bin:${PATH}" \
    PATH="/home/agent_lens/.local/bin:/home/agent_lens/.npm-global/bin:${PATH}"

# Copy Python files
COPY --chown=agent_lens:agent_lens pyproject.toml README.md ./
COPY --chown=agent_lens:agent_lens agent_lens ./agent_lens
COPY --chown=agent_lens:agent_lens scripts ./scripts

# Copy ONLY frontend source files (not node_modules)
COPY --chown=agent_lens:agent_lens frontend/package*.json frontend/vite.config.mjs ./frontend/
COPY --chown=agent_lens:agent_lens frontend/components ./frontend/components
COPY --chown=agent_lens:agent_lens frontend/utils ./frontend/utils
COPY --chown=agent_lens:agent_lens frontend/favicon ./frontend/favicon
COPY --chown=agent_lens:agent_lens frontend/public ./frontend/public
COPY --chown=agent_lens:agent_lens frontend/index.html ./frontend/
COPY --chown=agent_lens:agent_lens frontend/main.jsx ./frontend/
COPY --chown=agent_lens:agent_lens frontend/main.css ./frontend/
COPY --chown=agent_lens:agent_lens frontend/utils.jsx ./frontend/

# Configure npm and install frontend dependencies
RUN npm config set prefix '/home/agent_lens/.npm-global' && \
    npm install --prefix frontend patch-package && \
    npm install --prefix frontend && \
    npm install --prefix frontend react-color html2canvas && \
    cd frontend && \
    npm run build && \
    cd .. && \
    rm -rf frontend/node_modules && \
    npm cache clean --force

RUN pip install --upgrade pip
# Install PyTorch with CUDA support before other dependencies
# This ensures GPU support is available for BiomedCLIP model
RUN pip install --user torch==2.5.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 && \
    pip cache purge
# Install remaining dependencies
RUN pip install --user -e . && \
    pip cache purge
# Clean up Python bytecode and cache files to reduce image size
RUN find /home/agent_lens/.local -type d -name __pycache__ -exec rm -r {} + 2>/dev/null || true && \
    find /home/agent_lens/.local -type f -name "*.pyc" -delete 2>/dev/null || true && \
    find /app -type d -name __pycache__ -exec rm -r {} + 2>/dev/null || true && \
    find /app -type f -name "*.pyc" -delete 2>/dev/null || true
# Remove Python development headers and build tools to reduce size (not needed at runtime)
USER root
RUN apt-get remove -y python3.11-dev && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
USER agent_lens
# Ensure the start script is executable
RUN chmod +x /app/scripts/docker_start.sh

ENTRYPOINT ["/app/scripts/docker_start.sh"]