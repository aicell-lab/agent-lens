<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microscope Control</title>
    <script src="https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.48-post1/dist/hypha-rpc-websocket.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #app {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        #title {
            font-size: 2em;
            margin-bottom: 20px;
        }
        #viewer-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        #media {
            flex: 1 1 480px;
            max-width: 480px;
        }
        #control-panel {
            flex: 1 1 300px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 15px;
        }
        .btn-group-vertical > .btn {
            margin-bottom: 5px;
        }
        #well-plate-svg {
            margin-top: 20px;
        }
        img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const MicroscopeControl = () => {
    const [microscopeControl, setMicroscopeControl] = useState(null);
    const [snapshotImage, setSnapshotImage] = useState(null);
    const [illuminationIntensity, setIlluminationIntensity] = useState(50);
    const [illuminationChannel, setIlluminationChannel] = useState("0");
    const [cameraExposure, setCameraExposure] = useState(100);
    const [xMove, setXMove] = useState(1);
    const [yMove, setYMove] = useState(1);
    const [zMove, setZMove] = useState(0.1);
    const [isLightOn, setIsLightOn] = useState(false);
    const [isPlateScanRunning, setIsPlateScanRunning] = useState(false);
    const [log, setLog] = useState('');
    const [chatbotUrl, setChatbotUrl] = useState(null);
    const [svc, setSvc] = useState(null);  // Correctly initialize the similarity search service state
    const [numSimilarResults, setNumSimilarResults] = useState(5);
    const [searchResults, setSearchResults] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    const appendLog = (message) => {
        setLog(prevLog => prevLog + message + '\n');
    };

    useEffect(() => {
        const initializeWebRPC = async () => {
            try {
                appendLog('Connecting to server...');
                const server = await hyphaWebsocketClient.connectToServer({ 
                    "name": "js-client", 
                    "server_url": "https://ai.imjoy.io", 
                    "method_timeout": 10 
                });
                appendLog('Server connected.');
                
                appendLog('Getting microscope-control-squid-2 service...');
                const mc = await server.get_service("microscope-control-squid-test");
                appendLog('Service acquired.');

                appendLog('Getting image-embedding-similarity-search service...');
                const similarityService = await server.getService("image-embedding-similarity-search");
                appendLog('Similarity search service acquired.');
                
                setMicroscopeControl(mc);
                setSvc(similarityService);  // Set the similarity search service
            } catch (error) {
                appendLog(`Error: ${error.message}`);
            }
        };

        initializeWebRPC();
    }, []);

    const handleSimilaritySearch = async () => {
      if (!snapshotImage || !svc) {
        appendLog('No image or service available for similarity search.');
        return;
      }
  
      setIsLoading(true);
      appendLog('Starting similarity search...');
      try {
          // Fetch the image data as a Blob
          const response = await fetch(snapshotImage);
          const blob = await response.blob();

          // Convert Blob to ArrayBuffer
          const arrayBuffer = await new Response(blob).arrayBuffer();

          // Convert ArrayBuffer to Uint8Array
          const uint8Array = new Uint8Array(arrayBuffer);

          const imageData = {
              name: 'snapshot'
          };

          const results = await svc.find_similar_images(uint8Array, imageData, parseInt(numSimilarResults));
          appendLog(`Found ${results.length} similar images.`);
  
          setSearchResults(results);
      } catch (error) {
          appendLog(`Error searching for similar images: ${error.message}`);
      } finally {
          setIsLoading(false);
      }
    };

    const snapImage = async () => {
        if (!microscopeControl) return;
        try {
            appendLog('Snapping image...');
            const imageUrl = await microscopeControl.snap(
                parseInt(cameraExposure),
                parseInt(illuminationChannel),
                parseInt(illuminationIntensity)
            );
            setSnapshotImage(imageUrl);
            appendLog('Image snapped successfully.');
            appendLog(`Image URL: ${imageUrl}`);
        } catch (error) {
            appendLog(`Error snapping image: ${error.message}`);
        }
    };

    const moveMicroscope = async (direction, multiplier) => {
        if (!microscopeControl) return;
        try {
            let moveX = 0, moveY = 0, moveZ = 0;
            if (direction === 'x') moveX = xMove * multiplier;
            else if (direction === 'y') moveY = yMove * multiplier;
            else if (direction === 'z') moveZ = zMove * multiplier;
            
            appendLog(`Attempting to move by: ${moveX}, ${moveY}, ${moveZ}`);
            const result = await microscopeControl.move_by_distance(moveX, moveY, moveZ);
            if (result.success) {
                appendLog(result.message);
                appendLog(`Moved from (${result.initial_position.x}, ${result.initial_position.y}, ${result.initial_position.z}) to (${result.final_position.x}, ${result.final_position.y}, ${result.final_position.z})`);
            } else {
                appendLog(`Move failed: ${result.message}`);
            }
        } catch (error) {
            appendLog(`Error in moveMicroscope: ${error.message}`);
        }
    };

    const moveToPosition = async () => {
        if (!microscopeControl) return;
        try {
            appendLog(`Attempting to move to position: (${xMove}, ${yMove}, ${zMove})`);
            const result = await microscopeControl.move_to_position(xMove, yMove, zMove);
            if (result.success) {
                appendLog(result.message);
                appendLog(`Moved from (${result.initial_position.x}, ${result.initial_position.y}, ${result.initial_position.z}) to (${result.final_position.x}, ${result.final_position.y}, ${result.final_position.z})`);
            } else {
                appendLog(`Move failed: ${result.message}`);
            }
        } catch (error) {
            appendLog(`Error in moveToPosition: ${error.message}`);
        }
    };

    const toggleLight = async () => {
        if (!microscopeControl) return;
        try {
            if (!isLightOn) {
                await microscopeControl.on_illumination();
                appendLog('Light turned on.');
            } else {
                await microscopeControl.off_illumination();
                appendLog('Light turned off.');
            }
            setIsLightOn(!isLightOn);
        } catch (error) {
            appendLog(`Error toggling light: ${error.message}`);
        }
    };

    const startPlateScan = async () => {
        if (!microscopeControl) return;
        try {
            if (!isPlateScanRunning) {
                await microscopeControl.scan_well_plate();
                appendLog('Plate scan started.');
            } else {
                await microscopeControl.stop_scan();
                appendLog('Plate scan stopped.');
            }
            setIsPlateScanRunning(!isPlateScanRunning);
        } catch (error) {
            appendLog(`Error in plate scan: ${error.message}`);
        }
    };

    const setIllumination = async () => {
        if (!microscopeControl) return;
        try {
            await microscopeControl.set_illumination(
                parseInt(illuminationChannel),
                parseInt(illuminationIntensity)
            );
            appendLog(`Illumination set: Channel ${illuminationChannel}, Intensity ${illuminationIntensity}%`);
        } catch (error) {
            appendLog(`Error setting illumination: ${error.message}`);
        }
    };

    const setCameraExposureTime = async () => {
        if (!microscopeControl) return;
        try {
            await microscopeControl.set_camera_exposure(parseInt(cameraExposure));
            appendLog(`Camera exposure set to ${cameraExposure}ms`);
        } catch (error) {
            appendLog(`Error setting camera exposure: ${error.message}`);
        }
    };

    const openChatbot = async () => {
        if (!microscopeControl) return;
        try {
            appendLog('Getting chatbot URL...');
            const url = await microscopeControl.get_chatbot_url();
            setChatbotUrl(url);
            appendLog(`Chatbot URL: ${url}`);
            
            // Open a new window with the chatbot URL
            const chatWindow = window.open(url, 'ChatbotWindow', 'width=400,height=600,scrollbars=yes');
            if (chatWindow) {
                chatWindow.focus();
            } else {
                appendLog('Unable to open chatbot window. Please check your pop-up blocker settings.');
            }
        } catch (error) {
            appendLog(`Error opening chatbot: ${error.message}`);
        }
    };

    return (
      <div>
        <h1 id="title" className="text-center">WebRTC Microscope Control</h1>
    
        <div id="viewer-section" className="flex flex-wrap gap-4">
          <div id="media" className="shadow flex-1 min-w-[480px]">
            {snapshotImage ? (
              <img src={snapshotImage} alt="Snapshot" />
            ) : (
              <div className="bg-light flex items-center justify-center" style={{ height: "360px" }}>
                <span>No image available</span>
              </div>
            )}
          </div>
    
          <div className="flex-1 min-w-[300px]">
            <div className="control-group">
              <label>Stage Movement:</label>
              <div className="input-group mb-2">
                <input type="number" value={xMove} onChange={(e) => setXMove(parseFloat(e.target.value))} className="form-control" placeholder="X (mm)" />
                <input type="number" value={yMove} onChange={(e) => setYMove(parseFloat(e.target.value))} className="form-control" placeholder="Y (mm)" />
                <input type="number" value={zMove} onChange={(e) => setZMove(parseFloat(e.target.value))} className="form-control" placeholder="Z (mm)" />
              </div>
              <div className="btn-group-vertical btn-block">
                <button className="btn btn-secondary" onClick={() => moveMicroscope('y', 1)} disabled={!microscopeControl}><i className="fas fa-arrow-up"></i> Y+</button>
                <div className="btn-group">
                  <button className="btn btn-secondary" onClick={() => moveMicroscope('x', -1)} disabled={!microscopeControl}><i className="fas fa-arrow-left"></i> X-</button>
                  <button className="btn btn-secondary" onClick={() => moveMicroscope('x', 1)} disabled={!microscopeControl}><i className="fas fa-arrow-right"></i> X+</button>
                </div>
                <button className="btn btn-secondary" onClick={() => moveMicroscope('y', -1)} disabled={!microscopeControl}><i className="fas fa-arrow-down"></i> Y-</button>
                <div className="btn-group">
                  <button className="btn btn-secondary" onClick={() => moveMicroscope('z', -1)} disabled={!microscopeControl}><i className="fas fa-arrow-down"></i> Z-</button>
                  <button className="btn btn-secondary" onClick={() => moveMicroscope('z', 1)} disabled={!microscopeControl}><i className="fas fa-arrow-up"></i> Z+</button>
                </div>
              </div>
              <button className="btn btn-primary btn-block mt-2" onClick={moveToPosition} disabled={!microscopeControl}>Move to Position</button>
            </div>
    
            <div className="control-group">
              <button className={`btn btn-block ${isLightOn ? 'btn-success' : 'btn-warning'}`} onClick={toggleLight} disabled={!microscopeControl}>
                <span className={`fas ${isLightOn ? 'fa-lightbulb-on' : 'fa-lightbulb'}`}></span> Toggle Light
              </button>
            </div>
    
            <div className="control-group">
              <button className={`btn btn-block ${isPlateScanRunning ? 'btn-success' : 'btn-info'}`} onClick={startPlateScan} disabled={!microscopeControl}>
                <span className={`fas ${isPlateScanRunning ? 'fa-check' : 'fa-microscope'}`}></span> {isPlateScanRunning ? 'Stop Plate Scan' : 'Scan Plate'}
              </button>
            </div>
          </div>
    
          <div className="flex-1 min-w-[300px]">
            <div className="control-group">
              <div className="input-group mb-2">
                <input type="number" value={numSimilarResults} onChange={(e) => setNumSimilarResults(e.target.value)} className="form-control" placeholder="Number of similar results" />
              </div>
              <button className={`btn btn-info btn-block ${isLoading ? 'disabled' : ''}`} onClick={handleSimilaritySearch} disabled={!snapshotImage}>
                <span className={`fas ${isLoading ? 'fa-spinner fa-spin' : 'fa-search'}`}></span> Search Similar Images
              </button>
            </div>
    
            {searchResults.length > 0 && (
              <div className="mt-4">
                <h3>Similarity Search Results:</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                  {searchResults.map((result, index) => (
                    <div key={index} className="border rounded p-2">
                      <img src={`data:image/jpeg;base64,${result.image}`} alt={`Result ${index + 1}`} className="w-full mb-2 rounded-lg" />
                      <p className="text-sm text-gray-600">Channel: {result.fluorescent_channel}</p>
                      <p className="text-sm text-gray-600">Similarity: {result.similarity.toFixed(2)}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
    
        <div id="control-panel" className="flex flex-col gap-4">
          <div className="control-group">
            <button className="btn btn-primary btn-block" onClick={snapImage} disabled={!microscopeControl}>
              <span className="fas fa-camera"></span> Snap Image
            </button>
          </div>
    
          <div className="control-group">
            <label htmlFor="illumination-intensity">Illumination Intensity:</label>
            <input type="range" id="illumination-intensity" className="form-control-range" min="0" max="100" value={illuminationIntensity} onChange={(e) => setIlluminationIntensity(e.target.value)} />
            <span>{illuminationIntensity}%</span>
          </div>
    
          <div className="control-group">
            <label htmlFor="illumination-channel">Illumination Channel:</label>
            <select id="illumination-channel" className="form-control" value={illuminationChannel} onChange={(e) => setIlluminationChannel(e.target.value)}>
              <option value="0">BF LED matrix full</option>
              <option value="11">Fluorescence 405 nm Ex</option>
              <option value="12">Fluorescence 488 nm Ex</option>
              <option value="14">Fluorescence 561nm Ex</option>
              <option value="13">Fluorescence 638nm Ex</option>
              <option value="15">Fluorescence 730nm Ex</option>
            </select>
          </div>
    
          <div className="control-group">
            <label htmlFor="camera-exposure">Camera Exposure (ms):</label>
            <input type="number" id="camera-exposure" className="form-control" value={cameraExposure} min="1" max="1000" onChange={(e) => setCameraExposure(e.target.value)} />
          </div>
    
          <div className="control-group">
            <button className="btn btn-primary btn-block" onClick={setIllumination} disabled={!microscopeControl}>Set Illumination</button>
            <button className="btn btn-primary btn-block" onClick={setCameraExposureTime} disabled={!microscopeControl}>Set Camera Exposure</button>
          </div>
    
          <div className="control-group">
            <button className="btn btn-info btn-block" onClick={openChatbot} disabled={!microscopeControl}>
              <span className="fas fa-comments"></span> Chat
            </button>
          </div>
        </div>
    
        <div className="mt-4">
          <h4>Log:</h4>
          <pre className="bg-light p-2" style={{ maxHeight: "200px", overflowY: "auto" }}>{log}</pre>
        </div>
      </div>
    );
};

ReactDOM.render(<MicroscopeControl />, document.getElementById('app'));
</script>
</body>
</html>
